<Project DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

	<!-- Settings -->

	<PropertyGroup>
		<ZipStoragePath>D:\Builds\Zips\SvnBridge</ZipStoragePath>
		<BuildType>Release</BuildType>
		<Revision>$(ccnetlabel)</Revision>
	</PropertyGroup>

	<!-- CruiseControl targets -->

	<Target Name="Cruise" DependsOnTargets="CruiseNoZip;Zip" />
	<Target Name="CruiseNoZip" DependsOnTargets="Clean;SetVersionNumber;Test"/>

	<!-- Meta-targets -->

	<Target Name="Test" DependsOnTargets="UnitTest;ProtocolTest" />

  <Target Name="Zip" DependsOnTargets="Merge">
    <Exec Command="$(CodePlex3rdParty)\zip.exe -9 -q -j $(ZipStoragePath)\SvnBridge-build-$(Revision).zip Merge\SvnBridge.exe"/>
  </Target>

	<!-- Individiual targets -->

	<Target Name="Clean">
		<MSBuild Projects="SvnBridge.sln" Targets="Clean" Properties="Configuration=$(BuildType)"/>
	</Target>

	<Target Name="Build">
		<MSBuild Projects="SvnBridge.sln" Targets="Build" Properties="Configuration=$(BuildType)"/>
	</Target>

	<Target Name="UnitTest" DependsOnTargets="Build">
    <Exec Command="$(CodePlex3rdParty)\nunit-console.exe Tests\bin\$(BuildType)\Tests.dll /noshadow /xml=TestsUnit.results.xml "/>
	</Target>

  <Target Name="ProtocolTest" DependsOnTargets="Build">
    <Exec Command="$(CodePlex3rdParty)\nunit-console.exe TestsProtocol\bin\$(BuildType)\TestsProtocol.dll /noshadow /xml=TestsProtocol.results.xml "/>
  </Target>

  <Target Name="IntegrationTest" DependsOnTargets="Build">
    <Exec Command="$(CodePlex3rdParty)\nunit-console.exe IntegrationTests\bin\$(BuildType)\IntegrationTests.dll /noshadow /xml=TestsIntegration.results.xml "/>
  </Target>

	<Target Name="SetVersionNumber">
    <Exec Command="$(CodePlex3rdParty)\AssemblyInfoUpdater.exe $(Revision) SvnBridgeLibrary\Properties\AssemblyInfo.cs"/>
    <Exec Command="$(CodePlex3rdParty)\AssemblyInfoUpdater.exe $(Revision) SvnBridge\Properties\AssemblyInfo.cs"/>
  </Target>

  <Target Name="Merge">
    <MakeDir Directories="Merge"/>
    <Exec Command="$(CodePlex3rdParty)\ilmerge.exe /out:Merge\SvnBridge.exe SvnBridge\bin\$(BuildType)\SvnBridge.exe SvnBridge\bin\$(BuildType)\SvnFacade.Library.dll"/>
  </Target>

</Project>
